{"ast":null,"code":"'use strict';\n\nexports.__esModule = true;\nvar _extends = Object.assign || function (target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i];\n    for (var key in source) {\n      if (Object.prototype.hasOwnProperty.call(source, key)) {\n        target[key] = source[key];\n      }\n    }\n  }\n  return target;\n};\n\n// TODO: enterprise connections should not depend on database\n// connections. However, we now allow a username input to contain also\n// an email and this information is in the database module. We should\n// make this information flow from the UI (like we do for the startHRD\n// function). Including this dependency here allows us to do that\n// incrementally.\n\nexports.startHRD = startHRD;\nexports.cancelHRD = cancelHRD;\nexports.logIn = logIn;\nvar _index = require('../../store/index');\nvar _enterprise = require('../enterprise');\nvar _index2 = require('../../field/index');\nvar _email = require('../../field/email');\nvar _actions = require('../../core/actions');\nvar _index3 = require('../../core/index');\nvar l = _interopRequireWildcard(_index3);\nvar _captcha = require('../captcha');\nvar _index4 = require('../database/index');\nfunction _interopRequireWildcard(obj) {\n  if (obj && obj.__esModule) {\n    return obj;\n  } else {\n    var newObj = {};\n    if (obj != null) {\n      for (var key in obj) {\n        if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key];\n      }\n    }\n    newObj.default = obj;\n    return newObj;\n  }\n}\nfunction startHRD(id, email) {\n  (0, _index.swap)(_index.updateEntity, 'lock', id, _enterprise.toggleHRD, email);\n}\nfunction cancelHRD(id) {\n  (0, _index.swap)(_index.updateEntity, 'lock', id, function (m) {\n    m = (0, _enterprise.toggleHRD)(m, false);\n    m = (0, _index2.hideInvalidFields)(m);\n    return m;\n  });\n}\nfunction getConnectionScopesFrom(m, connection) {\n  var connectionScopes = l.auth.connectionScopes(m);\n  return connectionScopes.get(connection.get('name'));\n}\nfunction logIn(id) {\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n  var email = (0, _index2.getFieldValue)(m, (0, _index4.databaseLogInWithEmail)(m) ? 'email' : 'username');\n  var ssoConnection = (0, _enterprise.matchConnection)(m, email);\n  var enterpriseConnection = (0, _enterprise.enterpriseActiveFlowConnection)(m);\n  var connectionScopes = getConnectionScopesFrom(m, ssoConnection || enterpriseConnection);\n  var usernameField = (0, _index4.databaseLogInWithEmail)(m) ? 'email' : 'username';\n  var fields = [usernameField, 'password'];\n  var params = {\n    connection_scope: connectionScopes ? connectionScopes.toJS() : undefined\n  };\n  if (ssoConnection && !(0, _enterprise.isHRDActive)(m)) {\n    return logInSSO(id, ssoConnection, params);\n  }\n  var isCaptchaValid = (0, _captcha.setCaptchaParams)(m, params, false, fields);\n  if (!isCaptchaValid && !ssoConnection) {\n    return (0, _captcha.showMissingCaptcha)(m, id);\n  }\n  logInActiveFlow(id, params);\n}\nfunction logInActiveFlow(id, params) {\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n  var usernameField = (0, _enterprise.isHRDActive)(m) || !(0, _index4.databaseLogInWithEmail)(m) ? 'username' : 'email';\n  var originalUsername = (0, _index2.getFieldValue)(m, usernameField);\n  var connection = (0, _enterprise.enterpriseActiveFlowConnection)(m);\n  var username = l.defaultADUsernameFromEmailPrefix(m) ? (0, _email.emailLocalPart)(originalUsername) : originalUsername;\n  (0, _actions.logIn)(id, ['password', usernameField], _extends({}, params, {\n    connection: connection ? connection.get('name') : null,\n    username: username,\n    password: (0, _index2.getFieldValue)(m, 'password'),\n    login_hint: username\n  }), function (id, error, fields, next) {\n    var wasCaptchaInvalid = error && error.code === 'invalid captcha';\n    (0, _captcha.swapCaptcha)(id, false, wasCaptchaInvalid, next);\n  });\n}\nfunction logInSSO(id, connection, params) {\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n  var field = (0, _index4.databaseLogInWithEmail)(m) ? 'email' : 'username';\n  l.emitEvent(m, 'sso login', {\n    lockID: id,\n    connection: connection,\n    field: field\n  });\n  (0, _actions.logIn)(id, [field], _extends({}, params, {\n    connection: connection.get('name'),\n    login_hint: (0, _index2.getFieldValue)(m, field)\n  }));\n}","map":null,"metadata":{},"sourceType":"script"}